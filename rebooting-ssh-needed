# 1) Get worker node names
workers=$(oc get nodes -l node-role.kubernetes.io/worker \
  -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}')

# 2) Roll through workers one by one
for n in $workers; do
  echo "=== Rebooting $n ==="
  oc adm cordon "$n"
  oc adm drain "$n" --ignore-daemonsets --delete-emptydir-data --grace-period=60 --timeout=20m

  # Change user if not RHCOS; e.g. core/ec2-user/redhat/etc
  ssh core@"$n" "sudo systemctl reboot" || { echo "SSH reboot failed for $n"; exit 1; }

  echo "Waiting for $n to come back Ready..."
  # It will briefly be NotReady; wait until it is Ready again
  oc wait node/"$n" --for=condition=Ready --timeout=20m

  oc adm uncordon "$n"
  echo "=== $n is back ==="
done

# 3) Check cluster health
oc get nodes
oc get co
